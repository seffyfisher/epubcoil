<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB.js Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <style>
        html {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;

        }
        body {
            margin: 0;
            padding: 0;
        }
        #viewer {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
        }
        #viewer .click-region {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50%;
            z-index: 10;
        }
        #viewer .click-region.left {
            left: 0;
            width: 10vw;
        }
        #viewer .click-region.right {
            right: 0;
            width: 10vw;
        }
        #controls {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        #pageInfo {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <div id="controls">
        <button id="prevPage"><</button>
        <button id="nextPage">></button>
        <label for="themeSelect">Theme:</label>
        <select id="themeSelect">
            <option value="day">Day</option>
            <option value="night">Night</option>
            <option value="sepia">Sepia</option>
        </select>
        <label for="fontSizeSlider"> Size:</label>
        <input type="range" id="fontSizeSlider" min="12" max="60" value="26">
        <span id="fontSizeValue">26px</span>
    </div>
    <div id="viewer" tabindex="0">
       <div class="click-region left"></div>
        <div class="click-region right"></div>
    </div>
    <div id="pageInfo" style="display: none;">עמוד 1 / 1</div>

    <script>
        const viewer = document.getElementById('viewer');
        const prevPageButton = document.getElementById('prevPage');
        const nextPageButton = document.getElementById('nextPage');
        const fontSizeSlider = document.getElementById('fontSizeSlider');
        const fontSizeValue = document.getElementById('fontSizeValue');
        const themeSelect = document.getElementById('themeSelect');
        const pageInfo = document.getElementById('pageInfo');

        let book;
        let rendition;
        let currentPage = 1;
        let totalPages = 1;

        // Auto-load epub.epub
        window.addEventListener('DOMContentLoaded', () => {
            book = ePub('epub.epub');
            rendition = book.renderTo('viewer', {
                width: '100vw',
                height: '90vh'
            });

            const themes = {
            day: {
                body: { background: "#ffffff", color: "#000000" }
            },
            night: {
                body: { background: "#1c1c1c", color: "#ffffff" }
            },
            sepia: {
                body: { background: "#f5deb3", color: "#5b4636" }
            }
        };

        rendition.themes.fontSize(`${fontSizeValue}px`);
                    rendition.themes.register('day', themes.day);
                    rendition.themes.register('night', themes.night);
                    rendition.themes.register('sepia', themes.sepia);
                    rendition.themes.select('night');

            // Display the first page and calculate total pages
            rendition.display();
            book.ready.then(() => {
                book.locations.generate().then(() => {
                    const spineItems = book.spine.items;
                    totalPages = spineItems.length;
                    updatePageInfo(currentPage, totalPages);
                    pageInfo.style.display = 'block';
                });
            });

            // Update current page on navigation
            rendition.on('relocated', (location) => {
                const spineIndex = location.start.index;
                currentPage = spineIndex + 1; // Pages start at index 0
                updatePageInfo(currentPage, totalPages);
            });

            // Add swipe gestures and side click functionality
            addSwipeGestures();
            addSideClicks();
        });

        // Navigate to the previous page
        prevPageButton.addEventListener('click', () => {
            if (rendition && currentPage > 1) {
                rendition.prev();
            }
        });

        // Navigate to the next page
        nextPageButton.addEventListener('click', () => {
            if (rendition && currentPage < totalPages) {
                rendition.next();
            }
        });

        // Update font size when slider changes
        fontSizeSlider.addEventListener('input', (event) => {
            const fontSize = event.target.value;
            fontSizeValue.textContent = `${fontSize}px`;
            if (rendition) {
                rendition.themes.fontSize(`${fontSize}px`);
            }
        });

        // Change theme dynamically
        themeSelect.addEventListener('change', (event) => {
            const selectedTheme = event.target.value;
            if (rendition) {
                rendition.themes.select(selectedTheme);
            }
        });

        // Update page info display
        function updatePageInfo(currentPage, totalPages) {
            pageInfo.textContent = `Page ${currentPage} / ${totalPages}`;
        }

        // Add swipe gesture support
        function addSwipeGestures() {
            let touchStartX = 0;
            let touchEndX = 0;

            viewer.addEventListener('touchstart', (event) => {
                touchStartX = event.touches[0].clientX;
            });

            viewer.addEventListener('touchend', (event) => {
                touchEndX = event.changedTouches[0].clientX;
                handleSwipe();
            });

            function handleSwipe() {
                const swipeThreshold = 30; // Minimum swipe distance in pixels
                const swipeDistance = touchStartX - touchEndX;

                if (Math.abs(swipeDistance) > swipeThreshold) {
                    if (swipeDistance > 0) {
                        rendition.next(); // Swipe left: Next page
                    } else {
                        rendition.prev(); // Swipe right: Previous page
                    }
                }
            }
        }

        // Add side click functionality
        function addSideClicks() {
            const leftRegion = viewer.querySelector('.click-region.left');
            const rightRegion = viewer.querySelector('.click-region.right');

            leftRegion.addEventListener('click', () => {
                if (rendition && currentPage > 1) {
                    rendition.prev();
                }
            });

            rightRegion.addEventListener('click', () => {
                if (rendition && currentPage < totalPages) {
                    rendition.next();
                }
            });
        }
    </script>

</body>
</html>